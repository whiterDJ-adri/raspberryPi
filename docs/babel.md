# üìñ Gu√≠a Completa de Internacionalizaci√≥n con PyBabel

## üöÄ Resumen R√°pido

### Comandos Esenciales

```bash
# 1. Extraer cadenas del c√≥digo
pybabel extract -F babel.cfg -o locales/messages.pot .

# 2. Actualizar traducciones existentes
pybabel update -i locales/messages.pot -d locales

# 3. Compilar traducciones para producci√≥n
pybabel compile -d locales
```

### Para Nuevos Idiomas

```bash
# Inicializar un nuevo idioma (ej: franc√©s)
pybabel init -i locales/messages.pot -d locales -l fr
```

---

## üéØ Objetivo

Esta gu√≠a te ayudar√° a implementar un sistema completo de internacionalizaci√≥n (i18n) en tu proyecto usando **PyBabel**. Aprender√°s desde la configuraci√≥n inicial hasta la resoluci√≥n de errores comunes.

## ‚ö° Configuraci√≥n Inicial

### 1. Instalaci√≥n de Dependencias

```bash
pip install Flask-Babel Babel
```

### 2. Estructura de Directorios Recomendada

```Bash
proyecto/
‚îú‚îÄ‚îÄ babel.cfg                 # Configuraci√≥n de Babel
‚îú‚îÄ‚îÄ app.py                    # Aplicaci√≥n principal
‚îú‚îÄ‚îÄ locales/                  # Carpeta de traducciones
‚îÇ   ‚îú‚îÄ‚îÄ messages.pot          # Plantilla principal
‚îÇ   ‚îú‚îÄ‚îÄ es/LC_MESSAGES/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.po       # Traducciones en espa√±ol
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ messages.mo       # Archivo compilado
‚îÇ   ‚îî‚îÄ‚îÄ ca/LC_MESSAGES/
‚îÇ       ‚îú‚îÄ‚îÄ messages.po       # Traducciones en catal√°n
‚îÇ       ‚îî‚îÄ‚îÄ messages.mo       # Archivo compilado
‚îî‚îÄ‚îÄ templates/                # Plantillas HTML
    ‚îî‚îÄ‚îÄ *.html
```

### 3. Configuraci√≥n de `babel.cfg`

```ini
[python: **.py]
[jinja2: templates/**.html]
extensions=jinja2.ext.i18n
```

**¬øQu√© hace cada l√≠nea?**

- `[python: **.py]`: Escanea todos los archivos Python
- `[jinja2: templates/**.html]`: Escanea plantillas Jinja2 en la carpeta templates
- `extensions=jinja2.ext.i18n`: Habilita las funciones de traducci√≥n en Jinja2

---

## üîÑ Flujo de Trabajo Completo

### Paso 1: Marcar Cadenas para Traducir

**En archivos Python:**

```python
from flask_babel import gettext as _

# Marcar cadenas
mensaje = _("Bienvenido al sistema")
error = _("Usuario no encontrado")
```

**En plantillas HTML:**

```html
<h1>{{ _("T√≠tulo de la p√°gina") }}</h1>
<p>{{ _("Descripci√≥n del contenido") }}</p>
```

### Paso 2: Extraer Cadenas

```bash
pybabel extract -F babel.cfg -o locales/messages.pot .
```

### Paso 3: Crear/Actualizar Traducciones

**Para un nuevo idioma:**

```bash
pybabel init -i locales/messages.pot -d locales -l es
```

**Para actualizar idiomas existentes:**

```bash
pybabel update -i locales/messages.pot -d locales
```

### Paso 4: Traducir Cadenas

Edita los archivos `.po` y completa las traducciones:

```po
#: templates/index.html:15
msgid "Welcome"
msgstr "Bienvenido"

#: app.py:25
msgid "User not found"
msgstr "Usuario no encontrado"
```

### Paso 5: Compilar Traducciones

```bash
pybabel compile -d locales
```

---

## üõ†Ô∏è Configuraci√≥n en Flask

### Configuraci√≥n B√°sica en `app.py`

```python
from flask import Flask, request
from flask_babel import Babel

app = Flask(__name__)
app.config['SECRET_KEY'] = 'tu-clave-secreta'

# Configuraci√≥n de Babel
app.config.update(
    BABEL_DEFAULT_LOCALE='es',
    BABEL_DEFAULT_TIMEZONE='Europe/Madrid',
    LANGUAGES=['es', 'ca', 'en'],
    BABEL_TRANSLATION_DIRECTORIES='locales'
)

# Selector de idioma
def get_locale():
    return (
        request.args.get('lang') or
        request.accept_languages.best_match(app.config['LANGUAGES']) or
        'es'
    )

babel = Babel(app, locale_selector=get_locale)
```

### Cambio de Idioma en URLs

```html
<!-- Enlaces para cambiar idioma -->
<a href="?lang=es" class="btn btn-sm">Espa√±ol</a>
<a href="?lang=ca" class="btn btn-sm">Catal√†</a>
<a href="?lang=en" class="btn btn-sm">English</a>
```

---

## üîß Mini-Manuales para Errores Comunes

### ‚ùå Error: "No se encuentran nuevas cadenas"

**S√≠ntomas:**

- Ejecutas `pybabel extract` pero las nuevas cadenas no aparecen en el `.pot`

**Causas posibles:**

1. **Funci√≥n de traducci√≥n incorrecta**
2. **Configuraci√≥n de `babel.cfg` incorrecta**
3. **Ruta de archivos incorrecta**

**‚úÖ Soluciones:**

**1. Verificar funciones de traducci√≥n:**

```python
# ‚úÖ CORRECTO
from flask_babel import gettext as _
titulo = _("Mi t√≠tulo")

# ‚ùå INCORRECTO
titulo = gettext("Mi t√≠tulo")  # Sin importar como _
```

**2. Verificar babel.cfg:**

```ini
# ‚úÖ Para Flask con Jinja2
[python: **.py]
[jinja2: templates/**.html]
extensions=jinja2.ext.i18n

# ‚ùå Extensi√≥n incorrecta
[jinja2: templates/**.html]
extensions=jinja2.ext.autoescape  # Falta i18n
```

**3. Ejecutar desde la ra√≠z del proyecto:**

```bash
# ‚úÖ CORRECTO - desde la carpeta ra√≠z
cd /ruta/a/tu/proyecto
pybabel extract -F babel.cfg -o locales/messages.pot .

# ‚ùå INCORRECTO - desde subcarpeta
cd /ruta/a/tu/proyecto/templates
pybabel extract -F babel.cfg -o locales/messages.pot .
```

---

### ‚ùå Error: "Traducciones no se aplican en la web"

**S√≠ntomas:**

- Las cadenas siguen en el idioma original
- Los archivos `.po` est√°n traducidos

**Causas posibles:**

1. **Archivos `.mo` no compilados**
2. **Configuraci√≥n incorrecta en Flask**
3. **Ruta de `locales` incorrecta**

**‚úÖ Soluciones:**

**1. Compilar traducciones:**

```bash
# Siempre despu√©s de editar .po
pybabel compile -d locales

# Verificar que se crean los .mo
ls locales/es/LC_MESSAGES/  # Debe mostrar messages.mo
```

**2. Verificar configuraci√≥n Flask:**

```python
# ‚úÖ CORRECTO
app.config['BABEL_TRANSLATION_DIRECTORIES'] = 'locales'

# ‚ùå INCORRECTO
app.config['BABEL_TRANSLATION_DIRECTORIES'] = 'translations'  # Carpeta incorrecta
```

**3. Verificar estructura de carpetas:**

```Bash
locales/
‚îú‚îÄ‚îÄ es/LC_MESSAGES/
‚îÇ   ‚îú‚îÄ‚îÄ messages.po
‚îÇ   ‚îî‚îÄ‚îÄ messages.mo  ‚Üê Este archivo es crucial
‚îî‚îÄ‚îÄ ca/LC_MESSAGES/
    ‚îú‚îÄ‚îÄ messages.po
    ‚îî‚îÄ‚îÄ messages.mo  ‚Üê Este archivo es crucial
```

---

### ‚ùå Error: "UnicodeDecodeError" o caracteres extra√±os

**S√≠ntomas:**

- Caracteres como "√±", "√ß", acentos se muestran incorrectamente
- Errores de codificaci√≥n al compilar

**Causas posibles:**

1. **Codificaci√≥n incorrecta en archivos `.po`**
2. **Editor de texto con codificaci√≥n incorrecta**

**‚úÖ Soluciones:**

**1. Verificar cabecera de archivos `.po`:**

```po
# ‚úÖ CORRECTO
"Content-Type: text/plain; charset=utf-8\n"

# ‚ùå INCORRECTO
"Content-Type: text/plain; charset=iso-8859-1\n"
```

**2. Configurar editor correctamente:**

- **VS Code**: File ‚Üí Preferences ‚Üí Settings ‚Üí `files.encoding` ‚Üí UTF-8
- **Notepad++**: Encoding ‚Üí UTF-8
- **Vim**: `:set encoding=utf-8`

**3. Forzar UTF-8 al compilar:**

```bash
pybabel compile -d locales --statistics
```

---

### ‚ùå Error: "Cadenas marcadas como obsoletas (#~)"

**S√≠ntomas:**

- Traducciones aparecen con `#~` al principio
- Cadenas no se muestran traducidas

**Causas posibles:**

1. **Cadenas cambiadas en el c√≥digo**
2. **Actualizaci√≥n autom√°tica de babel**

**‚úÖ Soluciones:**

**1. Revisar cambios en el c√≥digo:**

```python
# ‚úÖ Si cambiaste esto:
_("Usuario logueado")
# ‚úÖ Por esto:
_("Usuario autenticado")

# La cadena anterior se marca como obsoleta
```

**2. Limpiar cadenas obsoletas manualmente:**

```bash
# Editar archivos .po y eliminar l√≠neas que empiecen con #~
```

**3. O regenerar desde cero:**

```bash
# ‚ö†Ô∏è CUIDADO: Esto borra todas las traducciones
rm locales/*/LC_MESSAGES/messages.po
pybabel init -i locales/messages.pot -d locales -l es
pybabel init -i locales/messages.pot -d locales -l ca
```

---

### ‚ùå Error: "babel.core.UnknownLocaleError"

**S√≠ntomas:**

```Bash
babel.core.UnknownLocaleError: unknown locale 'ca'
```

**Causas posibles:**

1. **C√≥digo de idioma no est√°ndar**
2. **Babel no reconoce el locale**

**‚úÖ Soluciones:**

**1. Usar c√≥digos est√°ndar:**

```bash
# ‚úÖ CORRECTO
pybabel init -i locales/messages.pot -d locales -l ca  # Catal√°n
pybabel init -i locales/messages.pot -d locales -l es  # Espa√±ol

# ‚ùå INCORRECTO
pybabel init -i locales/messages.pot -d locales -l cat  # No est√°ndar
```

**2. Verificar c√≥digos disponibles:**

```python
# En Python
from babel import Locale
print(Locale('ca'))  # Debe funcionar sin error
```

---

## üéØ Comandos Avanzados

### Extraer con opciones espec√≠ficas

```bash
# Excluir directorios espec√≠ficos
pybabel extract -F babel.cfg -o locales/messages.pot --no-location .

# A√±adir comentarios autom√°ticos
pybabel extract -F babel.cfg -o locales/messages.pot --add-comments=TRANSLATORS .

# Especificar palabras clave personalizadas
pybabel extract -F babel.cfg -k _ -k ngettext:1,2 -o locales/messages.pot .
```

### Actualizar con opciones

```bash
# Actualizar sin fuzzy matching (m√°s conservador)
pybabel update -i locales/messages.pot -d locales --no-fuzzy-matching

# Mostrar estad√≠sticas
pybabel update -i locales/messages.pot -d locales --statistics
```

### Compilar con verificaciones

```bash
# Compilar mostrando estad√≠sticas
pybabel compile -d locales --statistics

# Compilar solo archivos modificados
pybabel compile -d locales --use-fuzzy
```

---

## üîç Herramientas de Debugging

### Verificar configuraci√≥n actual

```python
# En tu aplicaci√≥n Flask
from flask_babel import get_locale
print(f"Idioma actual: {get_locale()}")

# Ver configuraci√≥n de Babel
print(app.config['BABEL_DEFAULT_LOCALE'])
print(app.config['LANGUAGES'])
```

### Comprobar traducciones cargadas

```python
from flask_babel import gettext as _
# En una vista o shell
print(_("Cadena de prueba"))  # Debe mostrar la traducci√≥n
```

### Script de verificaci√≥n

```python
# check_translations.py
import os
from pathlib import Path

def check_translation_files():
    locales_dir = Path('locales')
    languages = ['es', 'ca']

    for lang in languages:
        po_file = locales_dir / lang / 'LC_MESSAGES' / 'messages.po'
        mo_file = locales_dir / lang / 'LC_MESSAGES' / 'messages.mo'

        print(f"\n--- {lang.upper()} ---")
        print(f"PO existe: {po_file.exists()}")
        print(f"MO existe: {mo_file.exists()}")

        if po_file.exists() and mo_file.exists():
            po_time = po_file.stat().st_mtime
            mo_time = mo_file.stat().st_mtime
            print(f"MO actualizado: {'‚úÖ' if mo_time >= po_time else '‚ùå Recompilar'}")

if __name__ == '__main__':
    check_translation_files()
```

---

## üìã Checklist de Verificaci√≥n

### ‚úÖ Antes de hacer commit

- [ ] Todas las cadenas marcadas con `_()`
- [ ] `babel.cfg` configurado correctamente
- [ ] Plantilla `.pot` actualizada
- [ ] Archivos `.po` traducidos
- [ ] Archivos `.mo` compilados
- [ ] Probado en navegador con diferentes idiomas

### ‚úÖ Para deployment

- [ ] Solo archivos `.mo` en producci√≥n (opcional: excluir `.po`)
- [ ] Variables de entorno configuradas
- [ ] Rutas de `locales` correctas en servidor

---

## üìö Recursos Adicionales

### Editores Recomendados

- **Poedit**: Editor gr√°fico espec√≠fico para archivos `.po`
- **VS Code**: Con extensi√≥n "gettext"
- **Lokalize**: Editor avanzado para KDE

### Referencias Online

- [Documentaci√≥n oficial de Babel](https://babel.pocoo.org/)
- [Flask-Babel Documentation](https://flask-babel.tkte.ch/)
- [GNU gettext manual](https://www.gnu.org/software/gettext/manual/)

### Automatizaci√≥n

```bash
# Script completo de actualizaci√≥n
#!/bin/bash
echo "üîÑ Actualizando traducciones..."
pybabel extract -F babel.cfg -o locales/messages.pot .
pybabel update -i locales/messages.pot -d locales
echo "‚úÖ Listo para traducir. Ejecuta 'pybabel compile -d locales' despu√©s de traducir."
```

---

## üí° Consejos Finales

1. **Automatiza el proceso**: Crea scripts para extraer, actualizar y compilar
2. **Versionado**: Incluye archivos `.po` en git, pero considera excluir `.mo`
3. **Contexto**: A√±ade comentarios para traducciones ambiguas
4. **Pruebas**: Siempre prueba con diferentes idiomas antes del deployment
5. **Backup**: Guarda copias de archivos `.po` antes de regeneraciones masivas

---

_Este documento debe actualizarse seg√∫n evolucione tu proyecto. ¬°Mant√©n siempre la documentaci√≥n sincronizada con tu implementaci√≥n!_
